name: CF Workers

on:
Â  workflow_dispatch:
Â  push:
Â Â Â  branches:
Â Â Â Â Â  - master
Â Â Â  paths-ignore:
Â Â Â Â Â  - 'README.md'
Â Â Â Â Â  - 'LICENSE.md'
Â Â Â Â Â  - '.github/**'
Â Â Â Â Â  - '.cargo/**'
Â Â Â Â Â  - 'Cargo.lock'

jobs:
Â  check-host:
Â Â Â  name: Checking Host
Â Â Â  runs-on: ubuntu-latest
Â Â Â  outputs:
Â Â Â Â Â  has_failed_hosts: ${{ steps.check.outputs.has_failed_hosts }}
Â Â Â  steps:
Â Â Â Â Â  - uses: actions/checkout@v4
Â Â Â Â Â  - name: Clear older runs
Â Â Â Â Â Â Â  env:
Â Â Â Â Â Â Â Â Â  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
Â Â Â Â Â Â Â  run: |
Â Â Â Â Â Â Â Â Â  gh run list -L500 --json databaseId -q '.[].databaseId' | tail -n+11 | xargs -IID gh api "repos/$GITHUB_REPOSITORY/actions/runs/ID" -X DELETE || :
Â Â Â Â Â  - name: Check host
Â Â Â Â Â Â Â  id: check
Â Â Â Â Â Â Â  env:
Â Â Â Â Â Â Â Â Â  HOSTS: ${{ secrets.HOSTS }}
Â Â Â Â Â Â Â Â Â  TARGET_URL: ${{ secrets.TARGET }}
Â Â Â Â Â Â Â  run: |
Â Â Â Â Â Â Â Â Â  echo "ðŸ” Starting check host..."
Â Â Â Â Â Â Â Â Â  if [ -z "$HOSTS" ] || [ -z "$TARGET_URL" ]; then
Â Â Â Â Â Â Â Â Â Â Â  echo "::warning::HOSTS or TARGET_URL is empty, proceeding with deployment"
Â Â Â Â Â Â Â Â Â Â Â  echo "has_failed_hosts=true" >> $GITHUB_OUTPUT
Â Â Â Â Â Â Â Â Â Â Â  exit 0
Â Â Â Â Â Â Â Â Â  fi
Â Â Â Â Â Â Â Â Â  IFS=',' read -ra hosts <<< "$HOSTS"
Â Â Â Â Â Â Â Â Â  failed_hosts=()
Â Â Â Â Â Â Â Â Â  for host in "${hosts[@]}"; do
Â Â Â Â Â Â Â Â Â Â Â  host=$(echo "$host" | xargs)
Â Â Â Â Â Â Â Â Â Â Â  response=$(curl -s -i -H "Connection: Upgrade" -H "Upgrade: websocket" -H "Host: $host" -H "Sec-WebSocket-Version: 13" -H "Sec-WebSocket-Key: $(openssl rand -base64 16)" "https://$host/free/US" 2>&1 || true)
Â Â Â Â Â Â Â Â Â Â Â  location=$(echo "$response" | grep -i "location:" || true)
Â Â Â Â Â Â Â Â Â Â Â  status_code=$(echo "$response" | grep -i "^HTTP/" | awk '{print $2}' || echo "N/A")
Â Â Â Â Â Â Â Â Â Â Â  body=$(echo "$response" | sed -n '/^\r$/{:a;n;p;ba}' || true)
Â Â Â Â Â Â Â Â Â Â Â  if [[ "$location" != *"$TARGET_URL"* ]]; then
Â Â Â Â Â Â Â Â Â Â Â Â Â  failed_hosts+=("$host")
Â Â Â Â Â Â Â Â Â Â Â Â Â  echo "Checking: $host âŒ | Status: $body"
Â Â Â Â Â Â Â Â Â Â Â Â Â  printf "::error::Checking %s âŒ | Status: %s\n" "${host}" "${body}"
Â Â Â Â Â Â Â Â Â Â Â  else
Â Â Â Â Â Â Â Â Â Â Â Â Â  echo "Checking: $host âœ…"
Â Â Â Â Â Â Â Â Â Â Â  fi
Â Â Â Â Â Â Â Â Â  done
Â Â Â Â Â Â Â Â Â  if [ ${#failed_hosts[@]} -ne 0 ]; then
Â Â Â Â Â Â Â Â Â Â Â  echo "has_failed_hosts=true" >> $GITHUB_OUTPUT
Â Â Â Â Â Â Â Â Â  else
Â Â Â Â Â Â Â Â Â Â Â  echo "has_failed_hosts=false" >> $GITHUB_OUTPUT
Â Â Â Â Â Â Â Â Â Â Â  echo "ðŸŽ‰ All hosts passed"
Â Â Â Â Â Â Â Â Â  fi

Â  deploy:
Â Â Â  needs: check-host
Â Â Â  if: ${{ needs.check-host.outputs.has_failed_hosts == 'true' || github.event_name == 'push' }}
Â Â Â  name: Deploy
Â Â Â  runs-on: ubuntu-latest
Â Â Â  environment: cf
Â Â Â  steps:
Â Â Â Â Â  - uses: actions/checkout@v4
Â Â Â Â Â  - name: Deploy to Cloudflare Workers
Â Â Â Â Â Â Â  uses: cloudflare/wrangler-action@v3
Â Â Â Â Â Â Â  with:
Â Â Â Â Â Â Â Â Â  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
